name: SVN to GitHub Mirror
on:
  workflow_dispatch:
      inputs:
        logLevel:
          description: 'Log level'
          required: true
          default: 'warning'
        environment:
          description: 'Umgebung, in der der Workflow ausgefÃ¼hrt wird'
          required: true
          default: 'production'
          
jobs:
  sync:
    runs-on: macos-latest
    steps:
      # Schritt 1: Checkout master branch
      - name: Checkout master branch
        uses: actions/checkout@v4
        with:
          ref: master
          path: JADE

      # Schritt 2: Copy editAuthorfile Jar
      - name: Copy editAuthorfile.jar from master
        run: |
          mkdir -p $GITHUB_WORKSPACE/temp_jars
          cp JADE/Update/editAuthorfile.jar $GITHUB_WORKSPACE/temp_jars

      # Schritt 3: Checkout JADE-SVN-Tilab branch in ein separates Verzeichnis
      - name: Checkout JADE-SVN-Tilab branch
        uses: actions/checkout@v4
        with:
          ref: JADE-SVN-TILAB
          path: jade_svn_tilab     

      - name: Install SVN
        run: |
          brew install subversion

      - name: Install Git (includes git-svn)
        run: |
            brew install git-svn
            
      - name: Checkout SVN repository
        env:
          SVN_USER: ${{ secrets.JADE_USER }}
          SVN_PASSWORD: ${{ secrets.JADE_PASSWORD }}
        run: |        
          mkdir jadeSVN
          cd jadeSVN
          sudo svn --username $SVN_USER --password $SVN_PASSWORD --trust-server-cert checkout https://jade.tilab.com/svn/jade/trunk/ .
          svn info
          ls -d */
          svn info --show-item revision > actRevNumber.txt
          svn log --xml --quiet | grep author | sort -u | perl -pe 's/.*>(.*?)<.*/$1 = /' > authors.txt
          cd ../..
          ls -d */

      - name: Move files and directories
        run: |
          find jadeSVN/trunk/authors.txt -type f -print0 | xargs -0 mv -t .
          find jadeSVN/trunk/actRevNumber.txt -type f -print0 | xargs -0 mv -t .
          rm -rf jade
  
      - name: Run Java application
        run: java -jar editAuthorfile.jar $PWD/authors.txt das

      - name: Sync with SVN repository
        run: |
            git config svn.authorsfile $PWD/authors.txt
            RevNumber=$(grep -Eo '[0-9\.]+' actRevNumber.txt)
            sub=20
            mkdir jadeSVN
            cd jadeSVN
            git svn init https://jade.tilab.com/svn/jade/trunk/
            RevNumber=$(($RevNumber-$sub))
            git svn fetch -r$RevNumber:HEAD
            git remote add JADE-SVN-TILAB https://github.com/TBrandhorst/JADE.git
            git svn rebase

      - name: Push changes to GitHub
        run: git push origin JADE-SVN-Tilab --force
        env:
            GITHUB_TOKEN: ${{ secrets.TOKEN_GIT }}
